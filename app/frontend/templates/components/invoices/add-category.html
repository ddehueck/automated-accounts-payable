{% macro add_category_form(invoice_data) %}

<div x-data="
    {   
        editMode: false,
        inputValue: '',
        showOptions: false,
        savedCategories: {{invoice_data.categories}},
        defaults: ['Purchases', 'Maintenance and Repair', 'Entertainment', 'Travel', 'Equipment', 'Internet', 'Hosting', 'Furniture', 'Office Supplies', 'Vehicles', 'Accommodation', 'Continuing Education', 'Conferences And Seminars', 'Professional Fees', 'Marketing and Advertising', 'Business Insurance', 'Software and Subscription Services', 'Computer Repair', 'Fuel', 'Uncategorized Expenses', 'Other'],
    
        addCategory() {
            if (this.inputValue === '') return

            let tmp = this.inputValue;
            this.inputValue = '';

            fetch('/invoices/{{invoice_data.id}}/categories', {
                method: 'PUT',
                body: JSON.stringify({'category_name': tmp}),
                headers: {
                    'Content-Type': 'application/json'
                    }
            })
            .then(response => {
                if (response.ok) {
                    this.savedCategories.push(tmp);
                    this.editMode = true;
                } else {
                    console.log(`Something went wrong: ${response.status} - ${response.statusText}`);
                }
            })
        },

        deleteCategory(category) {
            if (!confirm('Are you sure you would like to remove category: ' + category + '?')) return

            fetch('/invoices/{{invoice_data.id}}/categories?category_name=' + category, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    this.savedCategories = this.savedCategories.filter(x => x !== category); 
                    this.editMode = true;
                } else {
                    console.log(`Something went wrong: ${response.status} - ${response.statusText}`);
                }
            })
        },

        dynamicOptions () {
            return this.defaults.filter(x => (x.includes(this.inputValue) || this.inputValue === '') && this.savedCategories.indexOf(x) == -1)
        },

        selectOption (option) {
            this.inputValue = option
        }
    }"
    class="mb-3"
>

    <!-- View Categories -->
    <div class="flex items-center mt-2">
        <span class="text-sm font-medium text-gray-500">Categories</span>
        <span x-cloak x-show="!editMode && savedCategories.length > 0" @click="editMode=true" class="ml-1 text-xs font-medium text-gray-500 hover:cursor-pointer hover:underline">(edit)</span>
        <span x-cloak x-show="editMode" @click="editMode=false" class="ml-1 text-xs font-medium text-gray-500 hover:cursor-pointer hover:underline">(done)</span>
    </div>

    <div class="flex flex-wrap max-w-full">
        <template x-for="category in savedCategories" :key="category">   
            <div class="mr-3 mt-3 relative inline-flex items-center justify-between px-4 py-2 rounded-md border border-gray-300 bg-white text-sm font-medium text-gray-700">
                <span x-text="category"></span>
                <span x-cloak x-show="editMode" @click="deleteCategory(category)" class="ml-2 p-1 hover:cursor-pointer hover:bg-slate-100 rounded-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </span>
            </div>
        </template>
    </div>

    <!-- Add Form Section -->
    <div x-cloak x-show="editMode" class="mt-3">
        <input type="text" x-model="inputValue" @click="showOptions=true" @click.outside="showOptions=false" placeholder="Add a new category" class="rounded-md text-sm font-normal text-gray-700 placeholder-gray-300 border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required/>
        <button type="button" @click="addCategory()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save</button>
    </div>

    <div x-cloak x-show="savedCategories.length === 0 && !editMode">
        <button type="button" @click="editMode=true" class="inline-flex items-center mt-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add Categories</button>
    </div>
    
    <!--
      Select popover, show/hide based on select state.

      Entering: ""
        From: ""
        To: ""
      Leaving: "transition ease-in duration-100"
        From: "opacity-100"
        To: "opacity-0"
    -->
    <div class="relative">
        <ul x-cloak
            x-show="showOptions && dynamicOptions().length > 0 && editMode"
            x-transition:enter="ease-linear duration-100" 
            x-transition:enter-start="opacity-0 scale-95" 
            x-transition:enter-end="opacity-100 scale-100" 
            x-transition:leave="transition-opacity ease-linear duration-100" 
            x-transition:leave-start="opacity-100 scale-100" 
            x-transition:leave-end="opacity-0 scale-95"
            class="absolute top-0 z-10 mt-1 w-80 bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm" 
            tabindex="-1" role="listbox" aria-labelledby="listbox-label" aria-activedescendant="listbox-option-3"
        >
            <template x-for="category in dynamicOptions()" :key="category">   
                <li @click="selectOption(category)" class="text-gray-900 cursor-default select-none relative py-2 pl-3 pr-9 hover:bg-slate-100 hover:cursor-pointer" id="listbox-option-0" role="option">
                    <!-- Selected: "font-semibold", Not Selected: "font-normal" -->
                    <span class="font-normal block truncate" x-text="category">  </span>
                </li>
            </template>
        </ul>
    </div>

</div>


{% endmacro %}